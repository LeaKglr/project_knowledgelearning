{% extends 'base.html.twig' %}

{% block title %}
    Cursus pour le th√®me {{ theme.name }}
{% endblock %}

{% block body %}

    <div class="body">
        <h1>üìö Cursus disponibles pour le th√®me : {{ theme.name }}</h1>

        <div class="courses">
            {% for course in courses %}
                <div class="course-card">

                    <h3>{{ course.name }}</h3>
                    <p>Prix : {{ course.price }} ‚Ç¨</p>

                    {% if app.user and app.user.isVerified %}
                        {% if course.id in validatedCourses %}
                            <!-- ‚úÖ Cursus valid√© -->
                            <a href="#" class="btn" id="ButtonValidated">Cursus valid√© ‚úÖ</a>
                        {% elseif purchasedCourses is not empty and course.id in purchasedCourses %}
                            <!-- üéì Cursus achet√© mais non valid√© -->
                            <a href="#" class="btn" id="goValidated">En avant pour valider les le√ßons !</a>
                        {% elseif course.id in partiallyPurchasedCourses %}
                            <!-- ‚ö†Ô∏è Certaines le√ßons du cursus ont d√©j√† √©t√© achet√©es -->
                            <a href="#" class="btn btn-warning">Impossible d'acheter le cursus : certaines le√ßons sont d√©j√† achet√©es.</a>
                            <p>Veuillez acheter le reste des le√ßons individuellement.</p>
                        {% else %}
                            <!-- üõí Achat du cursus -->
                            <button class="btn checkout-course-button" data-course-id="{{ course.id }}" id="buyCourseLesson">Acheter le cursus</button>
                        {% endif %}

                        <div class="card-body">
                            <h4>Le√ßons :</h4>  
                            {% for lesson in course.lessons %}                               
                                <div class="lesson">
                                    <p>{{ lesson.title }} - {{ lesson.price }} ‚Ç¨</p>
                                    {% if lesson.id in purchasedLessons %}
                                        <a href="{{ path('lesson_show', { id: lesson.id }) }}" class="btn" id="ButtonShowLesson">Voir la le√ßon</a>
                                    {% else %}
                                        <button class="btn checkout-button" data-lesson-id="{{ lesson.id }}" id="buyCourseLesson">Acheter la le√ßon</button>
                                    {% endif %}                                    
                                </div>
                            {% endfor %}                       
                        </div>
                    {% else %}
                        <p class="text-danger">‚ö†Ô∏è Vous devez v√©rifier votre email pour acheter une le√ßon ou un cursus.</p>
                    {% endif %}
                </div>
            {% else %}
                <p>Aucun cursus disponible pour ce th√®me.</p>
            {% endfor %}
        </div>
        <a href="{{ path('app_home') }}" class="btn btn-secondary" id="backhome">Retour √† l'accueil</a>
    </div>

    <script src="https://js.stripe.com/v3/"></script>

    <script>

        document.addEventListener("DOMContentLoaded", function () {
            attachStripeEventListeners(); // Recharge les boutons apr√®s rechargement de la page
        });

        function attachStripeEventListeners() { 
            const stripe = Stripe("{{ stripe_public_key }}");

            document.querySelectorAll(".checkout-button").forEach(button => {
                button.addEventListener("click", function () {
                    let lessonId = this.dataset.lessonId; // üî• R√©cup√®re l'ID de la le√ßon associ√©e au bouton

                    fetch("{{ path('stripe_checkout', { id: 'PLACEHOLDER' }) }}".replace("PLACEHOLDER", lessonId)) 
                        .then(response => response.json())
                        .then(session => {
                            if (session.id) {
                                return stripe.redirectToCheckout({ sessionId: session.id });
                            } else {
                                console.error("Session ID manquant");
                            }
                        })
                        .catch(error => console.error("Erreur :", error));
                });
            });

            document.querySelectorAll(".checkout-course-button").forEach(button => {
                button.addEventListener("click", function () {
                    const courseId = this.dataset.courseId;
                    fetch(`/stripe/checkout/course/${courseId}`)
                        .then(response => response.json())
                        .then(session => {
                            if (session.id) {
                                return stripe.redirectToCheckout({ sessionId: session.id });
                            } else {
                                console.error("Session ID manquant");
                            }
                        })
                        .catch(error => console.error("Erreur :", error));
                });
            });
        }
    </script>
{% endblock %}